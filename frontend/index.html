<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ribbit — File Explorer on Stellar Testnet via fr0g Protocol</title>
<script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"></script>
<script src="https://unpkg.com/@stellar/stellar-sdk@13/dist/stellar-sdk.min.js"></script>
<script src="fr0g.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root { --bg: #0a0e14; --text: #e2e8f0; --text-dim: #94a3b8; --accent: #60a5fa; --border: #1e293b; --card: #111827; }
body { background: var(--bg); color: var(--text); font-family: 'Inter', system-ui, sans-serif; margin:0; min-height:100vh; display:flex; flex-direction:column; }
.container { max-width:980px; margin:0 auto; padding:32px 16px; flex:1; }
header { border-bottom:1px solid var(--border); padding-bottom:32px; margin-bottom:40px; }
h1 { font-size:2.25rem; font-weight:700; color:#fff; }
.nav-tabs { display:flex; gap:2rem; border-bottom:1px solid var(--border); margin-bottom:2rem; font-size:1rem; font-weight:500; }
.nav-tabs button { padding:0.5rem 0; background:none; border:none; border-bottom:2px solid transparent; color:var(--text-dim); cursor:pointer; }
.nav-tabs button.active { color:var(--accent); border-bottom-color:var(--accent); }
.tab-content { display:none; }
.tab-content.active { display:block; animation:fadeIn .3s; }
@keyframes fadeIn { from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)} }
.card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:1.5rem; transition:all .2s; }
.card:hover { border-color:var(--accent); transform:translateY(-3px); }
.modal { position:fixed; inset:0; background:rgba(0,0,0,0.92); display:none; align-items:center; justify-content:center; z-index:999; }
.modal-content { background:var(--card); border:1px solid var(--border); border-radius:12px; max-width:90%; max-height:92vh; overflow:auto; box-shadow:0 0 60px rgba(0,0,0,0.7); }
button.primary { background:var(--accent); color:#000; font-weight:600; border:none; border-radius:9999px; cursor:pointer; }

/* LOADING OVERLAY - BLOCCA TUTTO */
.loading-overlay {
  position: fixed; inset: 0; background: rgba(10,14,20,0.98); display: flex; align-items: center; justify-content: center;
  z-index: 9999; flex-direction: column; gap: 1.5rem;
}
.loading-logo { display:flex; align-items:center; gap:1rem; }
.loading-logo img { height:48px; width:auto; }
.loading-text { font-size:1.25rem; font-weight:600; }
.progress-container { width:320px; height:6px; background:var(--border); border-radius:9999px; overflow:hidden; }
.progress-bar { height:100%; background:linear-gradient(to right, var(--accent), #3b82f6); width:0%; transition:width 0.4s ease-out; border-radius:9999px; }
.loading-status { font-size:0.875rem; color:var(--text-dim); font-family:'IBM Plex Mono', monospace; }
</style>
</head>
<body>

<!-- LOADING OVERLAY -->
<div id="loading-overlay" class="loading-overlay">
  <div class="loading-logo">
    <img src="logo.jpeg" alt="Ribbit Logo">
    <h1 class="text-3xl font-bold">Ribbit</h1>
  </div>
  <div id="loading-text" class="loading-text">Initializing fr0g Protocol...</div>
  <div class="progress-container"><div id="progress-bar" class="progress-bar"></div></div>
  <div id="loading-status" class="loading-status">Loading Pyodide runtime...</div>
</div>

<div class="container">
  <header>
    <div class="flex items-center gap-4">
      <img src="logo.jpeg" alt="Ribbit Logo" class="h-12 w-auto">
      <h1>Ribbit</h1>
    </div>
    <div class="text-[var(--text-dim)] mt-3 text-lg">File explorer on Stellar Testnet via fr0g Protocol</div>
  </header>

  <div class="nav-tabs">
    <button id="tab0" class="active" onclick="switchTab(0)">Discover</button>
    <button id="tab1" onclick="switchTab(1)">Create ID</button>
    <button id="tab2" onclick="switchTab(2)">Upload</button>
    <button id="tab3" onclick="switchTab(3)">My Vault</button>
  </div>

  <!-- DISCOVER -->
  <div id="content0" class="tab-content active">
    <div class="flex justify-between items-center mb-8">
      <h2 class="text-2xl font-semibold">Latest Public Uploads</h2>
      <button onclick="loadLiveFeed()" class="primary px-6 py-2 rounded-xl">Refresh Feed</button>
    </div>
    <div id="feed" class="space-y-8"></div>
  </div>

  <!-- CREATE ID -->
  <div id="content1" class="tab-content">
    <h2 class="mb-6">Generate fr0g ID</h2>
    <button onclick="generateID()" id="genBtn" class="primary w-full py-4 text-lg">Generate New fr0g ID</button>
    <div id="id-result" class="hidden mt-8 space-y-6">
      <div>
        <div class="text-sm text-[var(--text-dim)] mb-1">Your fr0g ID</div>
        <div id="display-fr0g" class="font-mono bg-[#0d1117] p-4 border border-[var(--border)] rounded-xl break-all"></div>
      </div>
      <div>
        <div class="text-sm text-[var(--text-dim)] mb-1">Secret Key <span class="text-red-400">(save this securely — required to manage or delete files)</span></div>
        <div id="display-secret" class="font-mono bg-[#0d1117] p-4 border border-red-800 text-red-300 rounded-xl break-all"></div>
      </div>
      <div class="flex gap-4">
        <button onclick="copyToClipboard('id')" class="primary flex-1 py-3">Copy ID</button>
        <button onclick="copyToClipboard('secret')" class="bg-red-600 flex-1 py-3">Copy Secret Key</button>
      </div>
    </div>
  </div>

  <!-- UPLOAD -->
  <div id="content2" class="tab-content">
    <h2 class="mb-6">Upload Content</h2>
    <div id="drop-zone" class="border-2 border-dashed border-[var(--border)] rounded-2xl p-12 text-center cursor-pointer hover:border-[var(--accent)] transition-colors"
         ondrop="handleDrop(event)" ondragover="event.preventDefault()" onclick="document.getElementById('file-upload').click()">
      <p class="text-2xl mb-2">Drag &amp; drop file here</p>
      <p class="text-[var(--text-dim)]">or click to select</p>
      <input type="file" id="file-upload" class="hidden" onchange="handleFileSelect(event)">
    </div>

    <div id="preview-area" class="hidden mt-8 card">
      <div id="upload-form" class="space-y-6"></div>
      <button onclick="startUpload()" id="upload-btn" class="primary w-full mt-8 py-4">Upload Permanently to Stellar</button>
    </div>
  </div>

  <!-- MY VAULT -->
  <div id="content3" class="tab-content">
    <h2 class="mb-6">My Personal Vault</h2>
    <div class="flex gap-3">
      <input id="vault-id" placeholder="Enter your fr0g ID..." class="flex-1 bg-[#0d1117] border border-[var(--border)] rounded-xl px-4 py-3">
      <button onclick="loadVault()" class="primary px-8 py-3">Load Vault</button>
    </div>
    <div id="vault-files" class="mt-8 space-y-4"></div>
  </div>
</div>

<!-- MODAL PREVIEW -->
<div id="viewer-modal" class="modal">
  <div class="modal-content p-6 w-full max-w-4xl">
    <div class="flex justify-between mb-4">
      <h3 id="modal-title" class="font-semibold text-xl"></h3>
      <button onclick="closeModal()" class="text-3xl hover:text-white">×</button>
    </div>
    <div id="modal-body" class="bg-black rounded-2xl min-h-[420px] flex items-center justify-center"></div>
    <div class="mt-6 flex gap-4">
      <button onclick="closeModal()" class="flex-1 py-3 border border-[var(--border)] rounded-xl">Close</button>
      <button id="modal-download" class="flex-1 py-3 primary rounded-xl">Download File</button>
    </div>
  </div>
</div>

<script>
// ==================== LOADING ====================
const loadingOverlay = document.getElementById('loading-overlay');
const progressBar = document.getElementById('progress-bar');
const loadingStatus = document.getElementById('loading-status');
const loadingText = document.getElementById('loading-text');

function updateLoading(percent, statusText) {
  progressBar.style.width = percent + '%';
  loadingStatus.textContent = statusText;
  if (percent === 100) loadingText.textContent = "Pyodide + requests ready ✓";
}

// ==================== DISCOVER ====================
const HORIZON = "https://horizon-testnet.stellar.org";
const INDEXERS = {
  IMAGES: 'fr0gar7b4wscthfrqofckuq22clb3usofiud75gozxe26mqavyisrc5bemcg',
  VIDEOS: 'fr0gmypk54u3b5zytuzhwdbpxcyems234siebxa5wf2htz62smg4hbrtz5ag',
  WEBSITES: 'fr0gey3nkjwxfi3olj2opkjwzxg2prjxwyld3rxthfuzqd5ssyzisbr3fcbg',
  CODE: 'fr0g64n6okdmub2vqiiqmupwdtclsqakkbm3idbaz6c3kliddivpgfeetldg',
  RAW: 'fr0gcqkdfplmirjr5wxkez75mubdwow3i2ishskhgnesq4iyiishafeef2dg',
};

function fr0gToStellar(id) {
  if (!id || !id.startsWith("fr0g")) return null;
  const remaining = id.slice(4);
  const reversed = remaining.split("").reverse().join("");
  return reversed.toUpperCase();
}

function timeAgo(dateStr) {
  const seconds = Math.floor((Date.now() - new Date(dateStr)) / 1000);
  const intervals = [{d:31536000,l:"y"},{d:2592000,l:"mo"},{d:86400,l:"d"},{d:3600,l:"h"},{d:60,l:"m"}];
  for (const i of intervals) {
    const v = Math.floor(seconds / i.d);
    if (v >= 1) return v + i.l + " ago";
  }
  return "just now";
}

function parseMemo(text) {
  text = text.trim();
  if (!text) return null;
  const parts = text.split(";");
  const numStr = parts[0].trim();
  if (!/^\d+$/.test(numStr)) return null;
  return { index: parseInt(numStr,10), desc: parts.length > 1 ? parts.slice(1).join(";").trim() : "No description" };
}

async function fetchIndexerMemos(fr0gId) {
  const addr = fr0gToStellar(fr0gId);
  if (!addr) return [];
  const url = `${HORIZON}/accounts/${addr}/transactions?order=desc&limit=150&include_failed=false`;
  try {
    const r = await fetch(url);
    if (!r.ok) return [];
    const json = await r.json();
    const items = [];
    for (const tx of json._embedded?.records || []) {
      if (tx.memo_type !== "text") continue;
      const parsed = parseMemo(tx.memo);
      if (!parsed) continue;
      items.push({
        fr0gID: "fr0g" + tx.source_account.split("").reverse().join("").toLowerCase(),
        index: parsed.index,
        description: parsed.desc,
        time: tx.created_at,
        txHash: tx.hash,
        category: Object.keys(INDEXERS).find(k => INDEXERS[k] === fr0gId) || "RAW"
      });
    }
    return items.sort((a,b) => new Date(b.time) - new Date(a.time));
  } catch(e) { return []; }
}

async function loadLiveFeed() {
  const feed = document.getElementById('feed');
  feed.innerHTML = `<div class="text-center py-20 text-[var(--text-dim)]">Scanning Stellar Testnet for public uploads...</div>`;
  let all = [];
  for (const cat in INDEXERS) {
    const memos = await fetchIndexerMemos(INDEXERS[cat]);
    all.push(...memos);
  }
  const unique = new Map();
  all.forEach(m => unique.set(`${m.fr0gID}#${m.index}`, m));
  all = Array.from(unique.values()).sort((a,b) => new Date(b.time) - new Date(a.time)).slice(0,30);

  feed.innerHTML = '';
  if (all.length === 0) {
    feed.innerHTML = `<div class="text-center py-20 text-[var(--text-dim)]">No public uploads yet.<br>Be the first!</div>`;
    return;
  }
  all.forEach(item => {
    const div = document.createElement('div');
    div.className = "card cursor-pointer";
    div.innerHTML = `
      <div class="uppercase text-xs tracking-widest text-[var(--text-dim)] mb-2">${item.category}</div>
      <div class="font-medium text-xl leading-tight mb-4">${item.description}</div>
      <div class="font-mono text-xs text-[var(--text-dim)]">${item.fr0gID.slice(0,12)}…${item.fr0gID.slice(-8)}</div>
      <div class="flex justify-between text-xs mt-5 text-[var(--text-dim)]">
        <span>${timeAgo(item.time)}</span>
        <a href="https://horizon-testnet.stellar.org/transactions/${item.txHash}" target="_blank" class="text-[var(--accent)] hover:underline">View tx →</a>
      </div>
    `;
    div.onclick = () => showPublicContent(item.fr0gID, item.index, item.category, item.description);
    feed.appendChild(div);
  });
}

// ==================== MODAL ====================
async function showPublicContent(fr0gID, index, category, desc) {
  const modal = document.getElementById('viewer-modal');
  const body = document.getElementById('modal-body');
  const title = document.getElementById('modal-title');
  const downloadBtn = document.getElementById('modal-download');

  title.textContent = desc || category;
  body.innerHTML = `<div class="text-[var(--text-dim)]">Loading content from Stellar...</div>`;
  modal.style.display = 'flex';

  try {
    await initPyodide();
    const [bytes, mime] = await fr0g.get_content(fr0gID, index);
    const blob = new Blob([bytes], { type: mime || 'application/octet-stream' });
    const url = URL.createObjectURL(blob);

    downloadBtn.onclick = () => {
      const a = document.createElement('a');
      a.href = url;
      a.download = `${fr0gID}_${index}`;
      a.click();
    };

    if (mime.startsWith('image')) body.innerHTML = `<img src="${url}" class="max-h-[70vh] max-w-full object-contain">`;
    else if (mime.startsWith('video')) body.innerHTML = `<video src="${url}" controls autoplay class="max-h-[70vh] max-w-full">`;
    else if (mime === 'text/html') body.innerHTML = `<iframe src="${url}" class="w-full h-[70vh]"></iframe>`;
    else body.innerHTML = `<pre class="p-8 text-xs overflow-auto font-mono text-lime-400">${new TextDecoder().decode(bytes).slice(0,6000)}</pre>`;
  } catch(e) {
    body.innerHTML = `<div class="text-red-400 p-8">Error loading content.<br><small>Check console (F12)</small></div>`;
    console.error(e);
  }
}

function closeModal() { document.getElementById('viewer-modal').style.display = 'none'; }

// ==================== PYODIDE ====================
let isPyodideReady = false;
async function initPyodide() {
  if (isPyodideReady) return;
  updateLoading(20, "Loading Pyodide runtime...");
  window.pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.26.2/full/" });
  updateLoading(55, "Loading requests package...");
  await window.pyodide.loadPackage("requests");
  updateLoading(80, "Initializing fr0g protocol core...");
  await fr0g.init();
  updateLoading(100, "Pyodide + requests ready");
  isPyodideReady = true;

  setTimeout(() => {
    loadingOverlay.style.transition = 'opacity 0.6s ease';
    loadingOverlay.style.opacity = '0';
    setTimeout(() => { loadingOverlay.style.display = 'none'; }, 600);
  }, 400);
}

// ==================== ALTRE FUNZIONI (aggiungi qui le tue handleDrop, startUpload, loadVault, handleFileSelect ecc. dal file originale) ====================
async function generateID() {
  await initPyodide();
  const [id, secret] = await fr0g.random_keypair(1);
  document.getElementById('id-result').classList.remove('hidden');
  document.getElementById('display-fr0g').textContent = id;
  document.getElementById('display-secret').textContent = secret;
}

function copyToClipboard(type) {
  const txt = type === 'id' ? document.getElementById('display-fr0g').textContent : document.getElementById('display-secret').textContent;
  navigator.clipboard.writeText(txt).then(() => alert('✅ Copied to clipboard!'));
}

function switchTab(n) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.getElementById('content' + n).classList.add('active');
  document.querySelectorAll('.nav-tabs button').forEach(b => b.classList.remove('active'));
  document.getElementById('tab' + n).classList.add('active');
  if (n === 0) setTimeout(loadLiveFeed, 200);
}

window.onload = async () => {
  await initPyodide();
  switchTab(0);
};
</script>
</body>
</html>
